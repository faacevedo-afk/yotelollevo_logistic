@model IEnumerable<yotelollevo.Paquete>

@{
    var tiendas = ViewBag.Tiendas as IEnumerable<string> ?? Enumerable.Empty<string>();
    var estados = ViewBag.Estados as IEnumerable<string> ?? Enumerable.Empty<string>();
}

<div class="sgi-actions mb-3 d-flex gap-2 flex-wrap">
    <select id="filtroTienda" class="form-select" style="width:220px;">
        <option value="">Seleccione Tienda</option>
        @foreach (var t in tiendas)
        {
            <option value="@t">@t</option>
        }
    </select>

    <select id="filtroEstado" class="form-select" style="width:220px;">
        <option value="">Seleccione Estado</option>
        @foreach (var e in estados)
        {
            <option value="@e">@e</option>
        }
    </select>

    <input id="buscador" class="form-control" style="width:260px;" placeholder="Buscar" />

    <button id="btnBuscar" type="button" class="btn btn-primary">
        Buscar
    </button>

    <button id="btnLimpiar" type="button" class="btn btn-outline-secondary">
        Limpiar
    </button>
</div>

<div class="card shadow">
    <div class="card-header bg-dark text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Asignar Paquetes</h3>
            <a href="@Url.Action("Create", "Paquetes")" class="btn btn-outline-light btn-sm">
                Agregar Nuevo Paquete
            </a>
        </div>
    </div>

    <div class="card-body">
        <table id="tablaPaquetes" class="table table-striped table-bordered">
            <thead class="table-dark">
                <tr>
                    <th>ID</th>
                    <th>Destinatario</th>
                    <th>Dirección</th>
                    <th>Comuna</th>
                    <th>Tienda</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr>
                        <td>@item.IdPaquete</td>
                        <td>@item.NombreDestinatario</td>
                        <td>@item.DireccionEntrega</td>
                        <td>@item.Comuna.Nombre</td>
                        <td>@item.Tienda.Nombre</td>
                        <td>@item.Estado.Nombre</td>
                        <td class="text-nowrap">
                            <a class="btn btn-sm btn-outline-primary"
                               href="@Url.Action("Edit", "Paquetes", new { id = item.IdPaquete })">Editar</a>

                            <a class="btn btn-sm btn-outline-secondary"
                               href="@Url.Action("Details", "Paquetes", new { id = item.IdPaquete })">Ver</a>

                            <a class="btn btn-sm btn-outline-danger"
                               href="@Url.Action("Delete", "Paquetes", new { id = item.IdPaquete })">Eliminar</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@section scripts {
    <script>
        $(function () {

            // Verificación rápida
            if (!$('#tablaPaquetes').length) { console.error("No existe #tablaPaquetes"); return; }
            if (!$.fn.DataTable) { console.error("DataTables jQuery no cargó"); return; }

            // Inicializa DataTable
            const dt = $('#tablaPaquetes').DataTable({
                dom: "rtip",
                paging: true,
                searching: true,
                info: true,
                scrollX: true,
                pageLength: 10
            });

            function aplicarFiltros() {
                const tienda = $('#filtroTienda').val() || '';
                const estado = $('#filtroEstado').val() || '';
                const texto = $('#buscador').val() || '';

                // Columnas:
                // 0 ID, 1 Destinatario, 2 Dirección, 3 Comuna, 4 Tienda, 5 Estado, 6 Acciones
                dt.column(4).search(tienda, false, false);
                dt.column(5).search(estado, false, false);
                dt.search(texto);
                dt.draw();
            }

            $('#btnBuscar').on('click', function () {
                aplicarFiltros();
            });

            $('#btnLimpiar').on('click', function () {
                $('#filtroTienda').val('');
                $('#filtroEstado').val('');
                $('#buscador').val('');

                dt.column(4).search('');
                dt.column(5).search('');
                dt.search('');
                dt.draw();
            });

            $('#buscador').on('keydown', function (e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    aplicarFiltros();
                }
            });

            // (Opcional) aplicar al cambiar select sin apretar Buscar
            $('#filtroTienda, #filtroEstado').on('change', function () {
                aplicarFiltros();
            });
        });
    </script>
}
