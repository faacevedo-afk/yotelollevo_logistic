@model yotelollevo.ViewModels.TrabajarRutaVM

@{
    ViewBag.Title = "Trabajar en Ruta";
}

<h2>Ruta #@Model.IdRuta - @Model.FechaRuta.ToString("dd-MM-yyyy")</h2>

<div class="d-flex align-items-center gap-3 mb-4">
    @{
        string badgeClass = "bg-secondary";
        if (Model.EstadoRuta == "Planificada") { badgeClass = "bg-info text-dark"; }
        else if (Model.EstadoRuta == "EnCurso") { badgeClass = "bg-warning text-dark"; }
        else if (Model.EstadoRuta == "Cerrada") { badgeClass = "bg-dark"; }
    }
    <span class="badge @badgeClass fs-6">@Model.EstadoRuta</span>

    @if (Model.PuedeIniciar)
    {
        using (Html.BeginForm("CambiarEstadoRuta", "Rutas", FormMethod.Post, new { style = "display:inline" }))
        {
            @Html.AntiForgeryToken()
            <input type="hidden" name="IdRuta" value="@Model.IdRuta" />
            <input type="hidden" name="NuevoEstado" value="EnCurso" />
            <button type="submit" class="btn btn-success">
                <i class="fas fa-play"></i> Iniciar Ruta
            </button>
        }
    }

    @if (Model.PuedeCerrar)
    {
        using (Html.BeginForm("CambiarEstadoRuta", "Rutas", FormMethod.Post, new { style = "display:inline" }))
        {
            @Html.AntiForgeryToken()
            <input type="hidden" name="IdRuta" value="@Model.IdRuta" />
            <input type="hidden" name="NuevoEstado" value="Cerrada" />
            <button type="submit" class="btn btn-dark">
                <i class="fas fa-flag-checkered"></i> Cerrar Ruta
            </button>
        }
    }
</div>

@if (Model.Paquetes == null || !Model.Paquetes.Any())
{
    <div class="alert alert-info">No hay paquetes asignados a esta ruta.</div>
}
else
{
    <table class="table table-striped table-bordered">
        <thead class="table-dark">
            <tr>
                <th>#</th>
                <th>Destinatario</th>
                <th>Direccion</th>
                <th>Comuna</th>
                <th>Tienda</th>
                <th>Estado</th>
                <th>Observacion / Acciones</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var p in Model.Paquetes)
            {
                <tr>
                    <td>@p.OrdenEntrega</td>
                    <td>@p.Destinatario</td>
                    <td>@p.Direccion</td>
                    <td>@p.Comuna</td>
                    <td>@p.Tienda</td>
                    <td>
                        @{
                            string estBadge = "bg-secondary";
                            if (p.EstadoEntrega == "Entregado") { estBadge = "bg-success"; }
                            else if (p.EstadoEntrega == "Fallido") { estBadge = "bg-danger"; }
                            else if (p.EstadoEntrega == "EnRuta") { estBadge = "bg-warning text-dark"; }
                        }
                        <span class="badge @estBadge">@p.EstadoEntrega</span>
                        @if (p.HoraEvento.HasValue)
                        {
                            <br /><small class="text-muted">@p.HoraEvento.Value.ToString("HH:mm")</small>
                        }
                    </td>
                    <td>
                        @if (p.YaFinalizado)
                        {
                            <span class="text-muted">@p.Observacion</span>
                        }
                        else if (Model.EstadoRuta == "EnCurso")
                        {
                            using (Html.BeginForm("MarcarEntrega", "Rutas", FormMethod.Post, new { @class = "d-flex flex-column gap-1" }))
                            {
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="IdRutaPaquete" value="@p.IdRutaPaquete" />
                                <input type="hidden" name="IdRuta" value="@Model.IdRuta" />
                                <input type="text" name="Observacion" class="form-control form-control-sm mb-1"
                                       placeholder="Observacion..." value="@p.Observacion" />
                                <div class="d-flex gap-1">
                                    <button type="submit" name="NuevoEstado" value="Entregado"
                                            class="btn btn-success btn-sm flex-fill">
                                        <i class="fas fa-check"></i> Entregado
                                    </button>
                                    <button type="submit" name="NuevoEstado" value="Fallido"
                                            class="btn btn-danger btn-sm flex-fill">
                                        <i class="fas fa-times"></i> Fallido
                                    </button>
                                </div>
                            }
                        }
                        else
                        {
                            <span class="text-muted">-</span>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>
}

<a href="@Url.Action("Inicio", "Rutas")" class="btn btn-outline-secondary mt-2">
    <i class="fas fa-arrow-left"></i> Volver
</a>
