@{
    Layout = null;

    var userSession = new yotelollevo.Infrastructure.HttpUserSession(Session);
    var rol = userSession.Rol;
    var userName = !string.IsNullOrEmpty(userSession.UserName) ? userSession.UserName
                 : (!string.IsNullOrEmpty(rol) ? rol : "Invitado");

    bool isAdmin = userSession.IsAdmin;
    bool isTienda = userSession.IsTienda;
    bool isRepartidor = userSession.IsRepartidor;

    var actionRutasMenu = isRepartidor ? "Inicio" : "Index";
}
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>@ViewBag.Title - Yotelollevo</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />

    <!-- DataTables Bootstrap 5 CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/2.1.8/css/dataTables.bootstrap5.min.css" />

    <!-- Tu CSS personalizado -->
    <link href="~/Content/site.css" rel="stylesheet" />

    @RenderSection("Styles", required: false)
</head>

<body class="sgi-body">

    <!-- TOPBAR -->
    <header class="sgi-topbar">
        <div class="sgi-topbar-left">
            <a class="sgi-brand" href="@Url.Action("Index","Home")">
                <span class="sgi-brand-text">Yo te lo llevo - Logistica</span>
            </a>
        </div>

        <div class="sgi-topbar-actions">
            <button type="button" class="sgi-icon-btn" title="Ver/Ocultar menú" id="sidebarToggle">
                <i class="fa-solid fa-bars"></i>
            </button>
            <button type="button" class="sgi-icon-btn" title="Pantalla completa" id="btnFullscreen">
                <i class="fa-solid fa-expand"></i>
            </button>

            <div class="sgi-user dropdown">
                <a class="sgi-user-btn dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">
                    <span class="sgi-user-avatar"><i class="fa-solid fa-user"></i></span>
                    <span class="sgi-user-name">@userName</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="@Url.Action("Index","Home")">Perfil</a></li>
                    <li><hr class="dropdown-divider" /></li>
                    <li><a class="dropdown-item" href="@Url.Action("Logout","Account")">Cerrar sesión</a></li>
                </ul>
            </div>
        </div>
    </header>

    <!-- LAYOUT -->
    <div class="sgi-layout">

        <!-- SIDEBAR -->
        <aside class="sgi-sidebar" id="sgiSidebar">
            <nav class="sgi-menu">

                <!-- Home: todos -->
                <a class="sgi-item" href="@Url.Action("Index","Home")">
                    <i class="fa-solid fa-house"></i><span>Home</span>
                </a>

                @* =========================
                    SECCIÓN USUARIOS (solo ADMIN)
                    ========================= *@
                @if (isAdmin)
                {
                    <div class="sgi-section">
                        <div class="sgi-section-title">Usuarios</div>

                        <button class="sgi-item sgi-item-collapsible" type="button"
                                data-bs-toggle="collapse" data-bs-target="#mUsuarios" aria-expanded="true">
                            <i class="fa-solid fa-user-group"></i><span>Usuarios</span>
                            <i class="fa-solid fa-chevron-down sgi-chevron"></i>
                        </button>
                        <div class="collapse" id="mUsuarios">
                            <a class="sgi-subitem" href="@Url.Action("Index","Usuarios")">Gestionar</a>
                        </div>
                    </div>
                }

                @* =========================
                    SECCIÓN OPERACIÓN
                    - ADMIN: ve todo
                    - TIENDA: ve Pedidos + Rutas
                    - REPARTIDOR: ve Mi Ruta (Inicio)
                    ========================= *@
                <div class="sgi-section">
                    <div class="sgi-section-title">Operación</div>

                    @* Tiendas: solo ADMIN *@
                    @if (isAdmin)
                    {
                        <a class="sgi-item" href="@Url.Action("Index","Tiendas")">
                            <i class="fa-solid fa-store"></i><span>Tiendas</span>
                        </a>
                    }

                    @* Pedidos/Paquetes: ADMIN y TIENDA *@
                    @if (isAdmin || isTienda)
                    {
                        <a class="sgi-item" href="@Url.Action("Index","Paquetes")">
                            <i class="fa-solid fa-box"></i><span>Pedidos</span>
                        </a>
                    }

                    @* ✅ Rutas: todos, pero cambia la acción según rol *@
                    @if (isAdmin || isTienda || isRepartidor)
                    {
                        <a class="sgi-item" href="@Url.Action(actionRutasMenu, "Rutas")">
                            <i class="fa-solid fa-route"></i>
                            <span>@(isRepartidor ? "Mi Ruta" : "Rutas / Asignaciones")</span>
                        </a>
                    }

                    @* Repartidores: solo ADMIN *@
                    @if (isAdmin)
                    {
                        <a class="sgi-item" href="@Url.Action("Index","Repartidors")">
                            <i class="fa-solid fa-truck-fast"></i><span>Repartidores</span>
                        </a>
                    }
                </div>
            </nav>
        </aside>

        <!-- CONTENT -->
        <main class="sgi-content" id="sgiContent">
            @RenderBody()
        </main>

    </div>

    <!-- SCRIPTS - CDN DIRECTO (sin bundles) -->
    <!-- 1. jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- 2. Bootstrap Bundle (incluye Popper.js) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- 3. DataTables -->
    <script src="https://cdn.datatables.net/2.1.8/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/2.1.8/js/dataTables.bootstrap5.min.js"></script>

    <!-- Scripts inline para sidebar y fullscreen -->
    <script>
        (function () {
            const toggle = document.getElementById('sidebarToggle');
            const sidebar = document.getElementById('sgiSidebar');
            const content = document.getElementById('sgiContent');

            if (toggle && sidebar && content) {
                toggle.addEventListener('click', function () {
                    document.body.classList.toggle('sgi-collapsed');
                });
            }

            const btnFs = document.getElementById('btnFullscreen');
            if (btnFs) {
                btnFs.addEventListener('click', async function () {
                    try {
                        if (!document.fullscreenElement) {
                            await document.documentElement.requestFullscreen();
                        } else {
                            await document.exitFullscreen();
                        }
                    } catch (e) {
                        console.error('Error al cambiar pantalla completa:', e);
                    }
                });
            }
        })();
    </script>

    @RenderSection("scripts", required: false)
</body>
</html>
